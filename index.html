<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>مطبعة الثناء (سحابي)</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4361ee">
    <link rel="icon" type="image/png" href="icon.png">
    
    <!-- المكتبات الخارجية: أيقونات + تحويل HTML لصورة -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --primary: #4361ee; --bg-color: #f0f2f5; --card-bg: #ffffff;
            --text-main: #212529; --text-sub: #6c757d; --border: #edf2f7;
            --danger: #ef233c; --success: #2ec4b6; --warning: #ff9f1c;
        }
        [data-theme="dark"] {
            --bg-color: #1a1c23; --card-bg: #242731; --text-main: #f8f9fa;
            --text-sub: #adb5bd; --border: #323644;
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, sans-serif; transition: background 0.2s; }
        body { margin: 0; background: var(--bg-color); color: var(--text-main); overflow-x: hidden; user-select: none; }
        .hidden { display: none !important; }

        /* Login Screen */
        #login-screen {
            position: fixed; inset: 0; background: linear-gradient(135deg, #4361ee, #3f37c9);
            display: flex; align-items: center; justify-content: center; z-index: 5000;
        }
        .login-card { background: white; padding: 2.5rem; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; color: #333; }

        /* Layout */
        .header { background: var(--card-bg); padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .main-container { padding: 15px; max-width: 1200px; margin: 0 auto; padding-bottom: 100px; }
        .card { background: var(--card-bg); border-radius: 15px; padding: 18px; margin-bottom: 15px; border: 1px solid var(--border); }

        /* POS Grid */
        .pos-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 12px; }
        .product-item { background: var(--card-bg); border-radius: 12px; padding: 12px; text-align: center; border: 1px solid var(--border); cursor: pointer; }
        .stock-badge { font-size: 0.75rem; background: #eee; color: #555; padding: 2px 8px; border-radius: 10px; margin-top: 5px; display: inline-block; }

        /* Navigation */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: var(--card-bg); display: flex; justify-content: space-around; padding: 10px 0; border-top: 1px solid var(--border); z-index: 2000; }
        .nav-item { flex: 1; border: none; background: none; color: var(--text-sub); display: flex; flex-direction: column; align-items: center; font-size: 0.7rem; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item i { font-size: 1.3rem; margin-bottom: 4px; }

        /* Elements */
        .form-control { width: 100%; padding: 12px; border: 1.5px solid var(--border); border-radius: 10px; margin-bottom: 15px; background: var(--bg-color); color: var(--text-main); }
        .btn { border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-main { background: var(--primary); color: white; }
        
        #cart-drawer { position: fixed; bottom: 80px; left: 15px; right: 15px; background: var(--primary); color: white; border-radius: 15px; padding: 15px; display: flex; justify-content: space-between; align-items: center; transform: translateY(200%); transition: 0.4s; z-index: 1500; }
        #cart-drawer.active { transform: translateY(0); }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000; display: flex; align-items: center; justify-content: center; padding: 15px; }
        .modal-body { background: var(--card-bg); width: 100%; max-width: 450px; border-radius: 20px; padding: 25px; }
        
        /* Sales Log Table */
        .log-item { display: flex; justify-content: space-between; font-size: 0.85rem; padding: 8px 0; border-bottom: 1px solid var(--border); }

        /* ==================== أنماط الفاتورة ==================== */
        #invoice-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; display: none; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .invoice-box { background: #fff; width: 100%; max-width: 380px; border-radius: 8px; overflow: hidden; animation: popUp 0.3s ease; }
        
        #receipt-paper { padding: 20px; background: white; color: #000; font-family: 'Courier New', Courier, monospace; font-size: 13px; line-height: 1.4; border-bottom: 2px dashed #ccc; }
        .rec-header { text-align: center; margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 10px; }
        .rec-meta { font-size: 11px; margin-bottom: 10px; }
        .rec-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 12px; }
        .rec-table th { border-bottom: 1px solid #000; text-align: right; }
        .rec-table td { padding: 4px 0; text-align: right; }
        .rec-total { border-top: 2px solid #000; padding-top: 5px; text-align: center; font-weight: bold; font-size: 16px; margin-top: 10px; }
        
        .inv-actions { padding: 15px; background: #f1f2f6; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .btn-action { border: none; padding: 10px; border-radius: 5px; cursor: pointer; color: white; font-weight: bold; font-family: sans-serif; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-print { background: #2d3436; grid-column: span 2; }
        .btn-dl { background: #0984e3; }
        .btn-wa { background: #00b894; }
        .btn-close { background: #ff7675; grid-column: span 2; margin-top: 5px; }

        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        @media print {
            body > * { display: none !important; }
            #invoice-overlay, #invoice-overlay * { display: block !important; visibility: visible !important; }
            #invoice-overlay { position: absolute; left: 0; top: 0; background: white; padding: 0; }
            .invoice-box { box-shadow: none; max-width: 100%; width: 100%; }
            .inv-actions { display: none; }
            #receipt-paper { border: none; }
        }
    </style>
</head>
<body>
<!-- <button onclick="saveTest()">حفظ تجربة</button> -->
    <!-- تسجيل الدخول -->
    <div id="login-screen">
        <div class="login-card">
            <img src="icon.png" width="70" style="margin-bottom:10px;" onerror="this.style.display='none'">
            <h1 style="color: var(--primary); margin: 0 0 20px 0;">مطبعة الثناء</h1>
            <div id="login-error-msg" style="color:red; font-size:0.8rem; margin-bottom:10px;">جارِ تحميل البيانات...</div>
            <input type="text" id="user-field" class="form-control" placeholder="اسم المستخدم">
            <input type="password" id="pass-field" class="form-control" placeholder="كلمة المرور">
            <button class="btn btn-main" onclick="App.handleLogin()">دخول للنظام</button>
        </div>
    </div>

    <!-- واجهة التطبيق -->
    <header id="app-header" class="header hidden">
        <div style="font-weight: bold;"><i class="fas fa-book-open"></i> مطبعة الثناء</div>
        <div style="display: flex; gap: 15px; align-items: center;">
            <i class="fas fa-moon" onclick="UI.toggleTheme()" style="cursor: pointer;"></i>
            <span id="user-name-label" style="font-size: 0.7rem; background: var(--primary); color: white; padding: 3px 10px; border-radius: 20px;"></span>
        </div>
    </header>

    <main id="main-app" class="main-container hidden">
        <!-- الرئيسية -->
        <section id="dash-page">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                <div class="card" style="background: var(--primary); color: white; margin-bottom:0;">
                    <small>مبيعات اليوم</small> <h2 id="total-sales-val">0</h2>
                </div>
                <div class="card" style="border-right: 5px solid var(--success); margin-bottom:0;">
                    <small>صافي الربح</small> <h2 id="total-profit-val" style="color: var(--success);">0</h2>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-history"></i> سجل المبيعات (اليوم)</h3>
                <div id="sales-log-container"></div>
            </div>
        </section>

        <!-- البيع -->
        <section id="pos-page" class="hidden">
            <input type="text" id="pos-search-input" class="form-control" placeholder="بحث سريع عن مادة..." onkeyup="POS.render()">
            <div id="pos-products-list" class="pos-grid"></div>
        </section>

        <!-- الديون -->
        <section id="debt-page" class="hidden">
            <div class="card">
                <h3>سجل الديون والأجل</h3>
                <input type="text" id="debt-search-input" class="form-control" placeholder="بحث باسم الزبون..." onkeyup="Debts.render()">
                <div id="debt-items-list"></div>
            </div>
        </section>

        <!-- المخزن -->
        <section id="inv-page" class="hidden">
            <button class="btn btn-main" style="margin-bottom: 15px;" onclick="Inv.openAddModal()">+ إضافة منتج جديد</button>
            <div id="inv-items-list"></div>
        </section>

        <!-- الإعدادات -->
        <section id="set-page" class="hidden">
            <div class="card">
                <h3>إدارة الموظفين</h3>
                <div id="staff-items-list"></div>
                <button class="btn btn-main" style="margin-top: 10px; background:var(--success)" onclick="Users.openAddModal()">إضافة موظف</button>
            </div>
            <button class="btn" style="background: var(--danger); color: white;" onclick="App.logout()">خروج</button>
        </section>
    </main>

    <!-- سلة الشراء -->
    <div id="cart-drawer">
        <div><small>المجموع:</small> <div id="cart-total-val" style="font-size: 1.2rem; font-weight: bold;">0</div></div>
        <button class="btn" style="background: white; color: var(--primary); width: auto;" onclick="POS.showCheckout()">دفع / أجل</button>
    </div>

    <!-- التنقل -->
    <nav id="bottom-nav" class="bottom-nav hidden">
        <div class="nav-item active" onclick="UI.switchPage('dash', this)" id="btn-nav-dash"><i class="fas fa-chart-line"></i>الرئيسية</div>
        <div class="nav-item" onclick="UI.switchPage('pos', this)"><i class="fas fa-shopping-cart"></i>البيع</div>
        <div class="nav-item" onclick="UI.switchPage('debt', this)"><i class="fas fa-user-clock"></i>الديون</div>
        <div class="nav-item" onclick="UI.switchPage('inv', this)"><i class="fas fa-box"></i>المخزن</div>
        <div class="nav-item" onclick="UI.switchPage('set', this)" id="btn-nav-set"><i class="fas fa-cog"></i>الإعدادات</div>
    </nav>

    <!-- المودال -->
    <div id="modal-container" class="modal-overlay hidden">
        <div class="modal-body">
            <h3 id="modal-title-text">العنوان</h3>
            <div id="modal-content-area"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-main" id="modal-confirm-btn" style="flex: 2;">تأكيد</button>
                <button class="btn" onclick="UI.closeModal()" style="flex: 1; border:1px solid #ccc">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- نافذة الفاتورة -->
    <div id="invoice-overlay">
        <div class="invoice-box">
            <div id="receipt-paper"></div>
            <div class="inv-actions">
                <button class="btn-action btn-print" onclick="InvoiceSys.print()"><i class="fas fa-print"></i> طباعة الوصل</button>
                <button class="btn-action btn-dl" onclick="InvoiceSys.download()"><i class="fas fa-download"></i> تحميل صورة</button>
                <button class="btn-action btn-wa" onclick="InvoiceSys.share()"><i class="fab fa-whatsapp"></i> واتساب</button>
                <button class="btn-action btn-close" onclick="InvoiceSys.close()">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- كود الجافاسكربت وربط قاعدة البيانات -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

        // إعدادات فايربيس
        const firebaseConfig = {
            apiKey: "AIzaSyBjfP7o6GL6hb4kUS7-3H35u3qjaRKHJ0Y",
            authDomain: "database-4187a.firebaseapp.com",
            projectId: "database-4187a",
            storageBucket: "database-4187a.firebasestorage.app",
            messagingSenderId: "142567656823",
            appId: "1:142567656823:web:7348f2f971222731b0a572"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // البيانات المحلية (للعرض السريع)
        let DB = {
            products: [],
            sales: [],
            users: [],
            debts: [],
            config: JSON.parse(localStorage.getItem('LIB_DB_CONF')) || { theme: 'light' }
        };

        let cart = [];

        // دالة التحميل الرئيسية
        async function loadDataFromFirebase() {
            try {
                // جلب المنتجات
                const prodSnap = await getDocs(collection(db, "products"));
                DB.products = prodSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                // جلب المبيعات
                const saleSnap = await getDocs(collection(db, "sales"));
                DB.sales = saleSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                // جلب الديون
                const debtSnap = await getDocs(collection(db, "debts"));
                DB.debts = debtSnap.docs.map(d => ({ id: d.id, ...d.data() }));

                // جلب المستخدمين
                const userSnap = await getDocs(collection(db, "users"));
                DB.users = userSnap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                // إنشاء مدير افتراضي إذا كانت القاعدة فارغة
                if (DB.users.length === 0) {
                    const admin = { name: 'المدير', user: 'admin', pass: '123', role: 'admin' };
                    const docRef = await addDoc(collection(db, "users"), admin);
                    DB.users.push({ id: docRef.id, ...admin });
                }

                document.getElementById('login-error-msg').innerText = ""; 
                
                if(window.App.user) {
                    UI.updateDash(); POS.render(); Inv.render(); Debts.render(); Users.render();
                }

            } catch (error) {
                console.error("خطأ:", error);
                document.getElementById('login-error-msg').innerText = "فشل الاتصال بالقاعدة!";
            }
        }

        // --- ربط الدوال بالكائن Window ---

        window.App = {
            user: null,
            handleLogin: () => {
                const u = document.getElementById('user-field').value.trim();
                const p = document.getElementById('pass-field').value.trim();
                const found = DB.users.find(x => x.user === u && x.pass === p);

                if (found) {
                    window.App.user = found;
                    document.getElementById('login-screen').style.display = 'none';
                    document.getElementById('app-header').classList.remove('hidden');
                    document.getElementById('main-app').classList.remove('hidden');
                    document.getElementById('bottom-nav').classList.remove('hidden');
                    document.getElementById('user-name-label').innerText = found.name;

                    if(found.role !== 'admin') {
                        document.getElementById('btn-nav-dash').style.display = 'none';
                        document.getElementById('btn-nav-set').style.display = 'none';
                        UI.switchPage('pos', document.querySelectorAll('.nav-item')[1]);
                    }
                    UI.applyTheme(); 
                    UI.updateDash(); POS.render(); Inv.render(); Users.render(); Debts.render();
                } else {
                    document.getElementById('login-error-msg').innerText = "بيانات خاطئة أو جاري التحميل...";
                }
            },
            logout: () => location.reload()
        };

        window.UI = {
            switchPage: (p, btn) => {
                document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
                document.getElementById(p + '-page').classList.remove('hidden');
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                btn.classList.add('active');
            },
            toggleTheme: () => { 
                DB.config.theme = DB.config.theme === 'light' ? 'dark' : 'light'; 
                localStorage.setItem('LIB_DB_CONF', JSON.stringify(DB.config)); 
                UI.applyTheme(); 
            },
            applyTheme: () => document.documentElement.setAttribute('data-theme', DB.config.theme),
            openModal: (t, h, c) => {
                document.getElementById('modal-title-text').innerText = t;
                document.getElementById('modal-content-area').innerHTML = h;
                document.getElementById('modal-confirm-btn').onclick = c;
                document.getElementById('modal-container').classList.remove('hidden');
            },
            closeModal: () => document.getElementById('modal-container').classList.add('hidden'),
            updateDash: () => {
                const today = new Date().toLocaleDateString();
                const ts = DB.sales.filter(s => new Date(s.date).toLocaleDateString() === today);
                document.getElementById('total-sales-val').innerText = ts.reduce((a,b)=>a+b.total,0).toLocaleString() + " د.ع";
                document.getElementById('total-profit-val').innerText = ts.reduce((a,b)=>a+b.profit,0).toLocaleString() + " د.ع";
                
                document.getElementById('sales-log-container').innerHTML = ts.slice(-10).reverse().map(s => `
                    <div class="log-item">
                        <span>${s.items}</span>
                        <span><b>${s.total}</b> <small>(${s.seller})</small></span>
                    </div>
                `).join('') || "لا توجد مبيعات بعد";
            }
        };

        window.POS = {
            render: () => {
                const q = document.getElementById('pos-search-input').value.toLowerCase();
                document.getElementById('pos-products-list').innerHTML = DB.products.filter(p => p.name.toLowerCase().includes(q)).map(p => `
                    <div class="product-item" onclick="POS.add('${p.id}')">
                        <b>${p.name}</b><br>
                        <span style="color:var(--primary)">${p.sellPrice}</span><br>
                        <span class="stock-badge">${p.stock} قطعة</span>
                    </div>`).join('');
            },
            add: (id) => {
                const p = DB.products.find(x => x.id === id);
                if(p.stock <= 0) return alert("نفذ المخزون!");
                cart.push(p);
                document.getElementById('cart-total-val').innerText = cart.reduce((a,b)=>a+b.sellPrice,0).toLocaleString();
                document.getElementById('cart-drawer').classList.add('active');
            },
            showCheckout: () => {
                const total = cart.reduce((a,b)=>a+b.sellPrice,0);
                const html = `<h4>المجموع: ${total} د.ع</h4>
                              <input type="text" id="cust-name-debt" class="form-control" placeholder="اسم الزبون (للدين أو للفاتورة)">
                              <select id="pay-select" class="form-control"><option value="cash">نقدي (كاش)</option><option value="debt">أجل (دين)</option></select>`;
                UI.openModal("إتمام العملية", html, POS.complete);
            },
            complete: async () => {
                const method = document.getElementById('pay-select').value;
                const cust = document.getElementById('cust-name-debt').value;
                const totalSell = cart.reduce((a,b)=>a+b.sellPrice,0);
                const totalCost = cart.reduce((a,b)=>a+b.costPrice,0);
                const itemNames = cart.map(i => i.name).join('، ');

                if(method === 'debt' && !cust) return alert("اكتب اسم الزبون!");

                // تحديث المخزون
                for (let item of cart) {
                    const productInDB = DB.products.find(p => p.id === item.id);
                    if (productInDB) {
                        productInDB.stock--; 
                        await updateDoc(doc(db, "products", item.id), { stock: productInDB.stock });
                    }
                }
                
                const dateISO = new Date().toISOString();
                
                if(method === 'debt') {
                    const newDebt = { customer: cust, amount: totalSell, date: dateISO };
                    const docRef = await addDoc(collection(db, "debts"), newDebt);
                    DB.debts.push({ id: docRef.id, ...newDebt });
                } else {
                    const newSale = { items: itemNames, total: totalSell, profit: totalSell - totalCost, date: dateISO, seller: App.user.name };
                    const docRef = await addDoc(collection(db, "sales"), newSale);
                    DB.sales.push({ id: docRef.id, ...newSale });
                }

                // الفاتورة
                const invoiceCart = [...cart];
                window.InvoiceSys.generate(invoiceCart, totalSell, cust, method);

                cart = []; 
                POS.render(); UI.updateDash(); Debts.render();
                UI.closeModal();
                document.getElementById('cart-drawer').classList.remove('active');
            }
        };

        window.InvoiceSys = {
            currentData: null,
            generate: (items, total, cust, type) => {
                const id = Date.now().toString().slice(-6);
                const date = new Date().toLocaleString('ar-IQ');
                const typeLabel = type === 'debt' ? 'أجل (دين)' : 'نقدي';
                const custLabel = cust || 'زبون عام';
                let rows = items.map(i => `<tr><td>${i.name}</td><td style="text-align:center">1</td><td>${i.sellPrice.toLocaleString()}</td></tr>`).join('');
                const html = `
                    <div class="rec-header"><h2 style="margin:0">مطبعة الثناء</h2><div>فاتورة مبيعات</div></div>
                    <div class="rec-meta"><div><b>رقم الوصل:</b> #${id}</div><div><b>التاريخ:</b> ${date}</div><div><b>العميل:</b> ${custLabel}</div><div><b>نوع الدفع:</b> ${typeLabel}</div></div>
                    <hr style="border-top:1px dashed #000">
                    <table class="rec-table"><thead><tr><th>المادة</th><th style="text-align:center">العدد</th><th>السعر</th></tr></thead><tbody>${rows}</tbody></table>
                    <div class="rec-total">الإجمالي: ${total.toLocaleString()} د.ع</div>
                    <div style="text-align:center; margin-top:20px; font-size:10px">شكراً لتسوقكم معنا</div>
                `;
                document.getElementById('receipt-paper').innerHTML = html;
                window.InvoiceSys.currentData = { id, total, cust: custLabel, date };
                document.getElementById('invoice-overlay').style.display = 'flex';
            },
            print: () => window.print(),
            download: () => {
                const element = document.getElementById('receipt-paper');
                html2canvas(element).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `Invoice-${window.InvoiceSys.currentData.id}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                });
            },
            share: () => {
                if(!window.InvoiceSys.currentData) return;
                const d = window.InvoiceSys.currentData;
                const text = `*فاتورة مبيعات - مطبعة الثناء*%0aرقم: ${d.id}%0aالعميل: ${d.cust}%0aالتاريخ: ${d.date}%0a*الإجمالي: ${d.total.toLocaleString()} د.ع*`;
                window.open(`https://wa.me/?text=${text}`, '_blank');
            },
            close: () => document.getElementById('invoice-overlay').style.display = 'none'
        };

        window.Debts = {
            render: () => {
                const q = document.getElementById('debt-search-input').value.toLowerCase();
                document.getElementById('debt-items-list').innerHTML = DB.debts.filter(d => d.customer.toLowerCase().includes(q)).map(d => `
                    <div class="card" style="display:flex; justify-content:space-between; align-items:center; border-right: 5px solid var(--danger);">
                        <div><b>${d.customer}</b><br><small>${new Date(d.date).toLocaleDateString()}</small></div>
                        <div style="text-align:left"><b style="color:var(--danger)">${d.amount}</b><br>
                        <button onclick="Debts.payModal('${d.id}')" style="border:none; color:var(--success); background:none; font-weight:bold; cursor:pointer">تسديد 💸</button></div>
                    </div>`).join('') || "لا يوجد ديون.";
            },
            payModal: (id) => {
                const d = DB.debts.find(x => x.id === id);
                const html = `<p>الدين الكلي: <b>${d.amount}</b></p>
                              <input type="number" id="pay-amount-input" class="form-control" placeholder="المبلغ المراد تسديده الآن">`;
                UI.openModal("تسديد دين", html, () => Debts.processPay(id));
            },
            processPay: async (id) => {
                const paid = parseInt(document.getElementById('pay-amount-input').value);
                if(!paid || paid <= 0) return alert("أدخل مبلغاً صالحاً");
                
                const d = DB.debts.find(x => x.id === id);
                d.amount -= paid;

                if(d.amount <= 0) {
                    await deleteDoc(doc(db, "debts", id));
                    DB.debts = DB.debts.filter(x => x.id !== id);
                    alert("تم تسديد الدين بالكامل");
                } else {
                    await updateDoc(doc(db, "debts", id), { amount: d.amount });
                    alert(`تم خصم المبلغ. المتبقي: ${d.amount}`);
                }
                Debts.render(); UI.updateDash(); UI.closeModal();
            }
        };

        window.Inv = {
            render: () => {
                document.getElementById('inv-items-list').innerHTML = DB.products.map(p => `
                    <div class="card" style="display:flex; justify-content:space-between; align-items:center">
                        <div><b>${p.name}</b> (${p.stock} قطعة)<br><small>شراء: ${p.costPrice} | بيع: ${p.sellPrice}</small></div>
                        <button class="btn" style="width:auto; color:var(--danger)" onclick="Inv.del('${p.id}')"><i class="fas fa-trash"></i></button>
                    </div>`).join('');
            },
            openAddModal: () => {
                const h = `<input id="p-name-in" class="form-control" placeholder="اسم المادة">
                           <input type="number" id="p-cost-in" class="form-control" placeholder="سعر الشراء">
                           <input type="number" id="p-sell-in" class="form-control" placeholder="سعر البيع">
                           <input type="number" id="p-stock-in" class="form-control" placeholder="الكمية">`;
                UI.openModal("مادة جديدة", h, Inv.save);
            },
            save: async () => {
                const n = document.getElementById('p-name-in').value;
                const cp = parseInt(document.getElementById('p-cost-in').value);
                const sp = parseInt(document.getElementById('p-sell-in').value);
                const s = parseInt(document.getElementById('p-stock-in').value);
                
                if(n && sp) {
                    const newProd = { name: n, costPrice: cp, sellPrice: sp, stock: s };
                    const docRef = await addDoc(collection(db, "products"), newProd);
                    DB.products.push({ id: docRef.id, ...newProd });
                    Inv.render(); POS.render(); UI.closeModal(); 
                }
            },
            del: async (id) => { 
                if(confirm("حذف المادة؟")) { 
                    await deleteDoc(doc(db, "products", id));
                    DB.products = DB.products.filter(x => x.id !== id);
                    Inv.render(); POS.render(); 
                } 
            }
        };

        window.Users = {
            render: () => { 
                document.getElementById('staff-items-list').innerHTML = DB.users.map(u => `
                    <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding:10px; margin-bottom:5px">
                        <div>${u.name} <small>(${u.role})</small></div>
                        ${u.role !== 'admin' ? 
                          `<button class="btn" style="width:auto; background:var(--danger); color:white; padding:5px 10px; font-size:0.7rem" onclick="Users.delete('${u.id}')">حذف</button>` 
                          : '<i class="fas fa-shield-alt" style="color:var(--primary)"></i>'}
                    </div>
                `).join(''); 
            },
            openAddModal: () => {
                const h = `<input id="u-name-in" class="form-control" placeholder="الاسم الكامل"><input id="u-user-in" class="form-control" placeholder="اسم الدخول"><input id="u-pass-in" class="form-control" placeholder="كلمة المرور">`;
                UI.openModal("موظف جديد", h, Users.save);
            },
            save: async () => {
                const n = document.getElementById('u-name-in').value, u = document.getElementById('u-user-in').value, p = document.getElementById('u-pass-in').value;
                if(n && u && p) { 
                    const newUser = { name: n, user: u, pass: p, role: 'staff' };
                    const docRef = await addDoc(collection(db, "users"), newUser);
                    DB.users.push({ id: docRef.id, ...newUser });
                    Users.render(); UI.closeModal(); 
                }
            },
            delete: async (id) => {
                if(confirm("هل أنت متأكد من حذف هذا الموظف؟")) {
                    await deleteDoc(doc(db, "users", id));
                    DB.users = DB.users.filter(u => u.id !== id);
                    Users.render();
                }
            }
        };

        // تشغيل التحميل
        loadDataFromFirebase();
    </script>
</body>
</html>